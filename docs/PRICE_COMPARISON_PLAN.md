# План создания сравнения цен

## Цель
Создать таблицу сравнения цен, аналогичную файлу "сравнение цен.xlsx", но на основе собранных данных со всех сайтов.

## Структура целевого файла

### Колонки:
1. **Количество в остатках** - из INVENTORY
2. **Модель** - извлеченная модель (например, ECAM22.114.B)
3. **Наша цена** - из INVENTORY
4. **Магазин 1** - цены с сайтов конкурентов
5. **Магазин 2** - ...
6. **Магазин 3** - ...
7. **Магазин N** - ...

### Формат цен:
- Если есть скидка: `старая цена \ новая цена` (например, "1699 \ 1199")
- Если нет скидки: просто цена (например, "927")
- Если нет товара: "-"

## Этапы реализации

### Этап 1: Извлечение моделей ✅
**Задача**: Создать функцию для извлечения модели из названия товара

**Примеры**:
- "DeLonghi ECAM22.114.B" → "ECAM22.114.B"
- "Delonghi EC 9865 M" → "EC9865M" или "EC 9865 M"
- "Delonghi DL EC885.BG" → "EC885.BG"
- "Delonghi EC890.GR Dedica Duo" → "EC890.GR"
- "Coffee Machine DeLonghi EC890.GR" → "EC890.GR"

**Подход**:
1. Удалить бренд (DeLonghi, Delonghi)
2. Удалить общие слова (Coffee, Machine, Maker, etc.)
3. Найти паттерн модели (буквы + цифры + точки)
4. Нормализовать (убрать лишние пробелы, привести к единому виду)

### Этап 2: Загрузка данных ✅
**Источники**:
1. INVENTORY (остатки.xls) - наши цены и количество
2. ALTA - цены конкурента 1
3. KONTAKT - цены конкурента 2
4. ELITE - цены конкурента 3
5. DIM_KAVA - наш сайт (для проверки)

### Этап 3: Сопоставление моделей
**Задача**: Для каждого товара найти соответствия по модели

**Алгоритм**:
1. Извлечь модель из каждого товара
2. Создать словарь: модель → список товаров
3. Для каждой уникальной модели собрать цены из всех источников
4. Fuzzy matching для похожих моделей (опционально)

### Этап 4: Формирование итоговой таблицы
**Структура**:
```
| Qty | Model | Our Price | ALTA | KONTAKT | ELITE | DIM_KAVA |
|-----|-------|-----------|------|---------|-------|----------|
| 2   | ECAM22.114.B | 927 | - | - | 1699\1199 | 1699\1199 |
```

**Фильтрация**:
- Оставить только строки, где есть наша цена И хотя бы одна цена конкурента
- Сортировать по модели

### Этап 5: Экспорт результата
**Формат**: Excel файл с форматированием
- Выделить цветом строки, где наша цена ниже
- Выделить цветом строки, где наша цена выше
- Добавить статистику

## Технические детали

### Регулярные выражения для моделей

**Паттерны DeLonghi**:
- `ECAM\d+\.\d+\.?\w*` - ECAM22.114.B, ECAM350.55.B
- `EC\d+\.?\w*` - EC685.R, EC9865M
- `ESAM\d+` - ESAM4500
- `ECI\d+\.\w+` - ECI341.BK
- `KG\d+\.?\w*` - KG520.M (кофемолки)
- `KB\w+\d+\.?\w*` - KBD2001 (чайники)
- `CT\w+\d+\.?\w*` - CTOV2103.AZ (тостеры)

### Нормализация моделей

**Правила**:
1. Убрать "DL " префикс (DL EC885.BG → EC885.BG)
2. Убрать лишние пробелы (EC 9865 M → EC9865M или EC9865.M)
3. Привести к верхнему регистру
4. Сохранить точки и дефисы

### Обработка цен

**Форматы входных данных**:
- INVENTORY: числовое значение (927.00)
- Scraped sites: числовое значение + флаг скидки

**Формат вывода**:
- Со скидкой: "regular_price \ discount_price"
- Без скидки: "price"
- Нет данных: "-"

## Файлы для создания

1. `utils/model_extractor.py` - извлечение моделей
2. `price_comparison_builder.py` - основной скрипт
3. `tests/test_model_extraction.py` - тесты

## Ожидаемый результат

Файл `data/output/price_comparison_YYYYMMDD_HHMMSS.xlsx`:
- Строки только с нашими товарами, которые есть у конкурентов
- Четкое сопоставление по моделям
- Удобный формат для анализа
- Статистика по конкурентоспособности цен

